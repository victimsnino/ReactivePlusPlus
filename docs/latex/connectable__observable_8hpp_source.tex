\hypertarget{connectable__observable_8hpp_source}{}\doxysection{connectable\+\_\+observable.\+hpp}
\label{connectable__observable_8hpp_source}\index{src/rpp/rpp/observables/connectable\_observable.hpp@{src/rpp/rpp/observables/connectable\_observable.hpp}}

\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{//                   ReactivePlusPlus library}}
\DoxyCodeLine{2 \textcolor{comment}{// }}
\DoxyCodeLine{3 \textcolor{comment}{//           Copyright Aleksey Loginov 2022 -\/ present.}}
\DoxyCodeLine{4 \textcolor{comment}{//  Distributed under the Boost Software License, Version 1.0.}}
\DoxyCodeLine{5 \textcolor{comment}{//     (See accompanying file LICENSE\_1\_0.txt or copy at}}
\DoxyCodeLine{6 \textcolor{comment}{//           https://www.boost.org/LICENSE\_1\_0.txt)}}
\DoxyCodeLine{7 \textcolor{comment}{// }}
\DoxyCodeLine{8 \textcolor{comment}{//  Project home: https://github.com/victimsnino/ReactivePlusPlus}}
\DoxyCodeLine{9 }
\DoxyCodeLine{10 \textcolor{preprocessor}{\#pragma once}}
\DoxyCodeLine{11 }
\DoxyCodeLine{12 \textcolor{preprocessor}{\#include <rpp/observables/constraints.hpp>}              \textcolor{comment}{// OriginalObservable type}}
\DoxyCodeLine{13 \textcolor{preprocessor}{\#include <rpp/operators/fwd/ref\_count.hpp>}              \textcolor{comment}{// include forwarding for member\_overload}}
\DoxyCodeLine{14 \textcolor{preprocessor}{\#include <rpp/subjects/constraints.hpp>}                 \textcolor{comment}{// type of subject used}}
\DoxyCodeLine{15 \textcolor{preprocessor}{\#include <rpp/subjects/type\_traits.hpp>}                 \textcolor{comment}{// deduce observable type by subject type}}
\DoxyCodeLine{16 \textcolor{preprocessor}{\#include <rpp/subscriptions/composite\_subscription.hpp>} \textcolor{comment}{// lifetime}}
\DoxyCodeLine{17 }
\DoxyCodeLine{18 \textcolor{preprocessor}{\#include <memory>}}
\DoxyCodeLine{19 \textcolor{preprocessor}{\#include <mutex>}}
\DoxyCodeLine{20 }
\DoxyCodeLine{21 \textcolor{keyword}{namespace }rpp}
\DoxyCodeLine{22 \{}
\DoxyCodeLine{31 \textcolor{keyword}{template}<constraint::decayed\_type                    Type,}
\DoxyCodeLine{32          subjects::constraint::subject\_of\_type<Type> Subject,}
\DoxyCodeLine{33          constraint::observable\_of\_type<Type>        OriginalObservable>}
\DoxyCodeLine{34 \textcolor{keyword}{class }connectable\_observable}
\DoxyCodeLine{35     : \textcolor{keyword}{public} decltype(std::declval<Subject>().get\_observable())}
\DoxyCodeLine{36     , \textcolor{keyword}{public} details::member\_overload<Type, connectable\_observable<Type, Subject, OriginalObservable>, details::ref\_count\_tag>}
\DoxyCodeLine{37 \{}
\DoxyCodeLine{38     \textcolor{keyword}{using} base = \textcolor{keyword}{decltype}(std::declval<Subject>().get\_observable());}
\DoxyCodeLine{39 \textcolor{keyword}{public}:}
\DoxyCodeLine{40     connectable\_observable(\textcolor{keyword}{const} OriginalObservable\& original\_observable, \textcolor{keyword}{const} Subject\& subject = Subject\{\})}
\DoxyCodeLine{41         : base\{subject.get\_observable()\}}
\DoxyCodeLine{42         , m\_original\_observable\{original\_observable\}}
\DoxyCodeLine{43         , m\_subject\{subject\} \{\}}
\DoxyCodeLine{44 }
\DoxyCodeLine{45     connectable\_observable(OriginalObservable\&\& original\_observable, \textcolor{keyword}{const} Subject\& subject = Subject\{\})}
\DoxyCodeLine{46         : base\{subject.get\_observable()\}}
\DoxyCodeLine{47         , m\_original\_observable\{std::move(original\_observable)\}}
\DoxyCodeLine{48         , m\_subject\{subject\} \{\}}
\DoxyCodeLine{49 }
\DoxyCodeLine{50     composite\_subscription connect(\textcolor{keyword}{const} composite\_subscription\& subscription = composite\_subscription\{\}) \textcolor{keyword}{const}}
\DoxyCodeLine{51     \{}
\DoxyCodeLine{52         \textcolor{keyword}{auto} subscriber              = m\_subject.get\_subscriber();}
\DoxyCodeLine{53         \textcolor{keyword}{auto} subscriber\_subscription = subscriber.get\_subscription();}
\DoxyCodeLine{54 }
\DoxyCodeLine{55         \{}
\DoxyCodeLine{56             std::lock\_guard lock(m\_state-\/>mutex);}
\DoxyCodeLine{57 }
\DoxyCodeLine{58             \textcolor{keywordflow}{if} (!m\_state-\/>sub.is\_empty())}
\DoxyCodeLine{59                 \textcolor{keywordflow}{return} subscription;}
\DoxyCodeLine{60 }
\DoxyCodeLine{61             m\_state-\/>sub = subscriber\_subscription.add(subscription);}
\DoxyCodeLine{62         \}}
\DoxyCodeLine{63 }
\DoxyCodeLine{64         subscription.add([state = m\_state, subscriber\_subscription]}
\DoxyCodeLine{65         \{}
\DoxyCodeLine{66             \textcolor{keyword}{auto} current\_sub = composite\_subscription::empty();}
\DoxyCodeLine{67             \{}
\DoxyCodeLine{68                 std::lock\_guard lock(state-\/>mutex);}
\DoxyCodeLine{69                 std::swap(current\_sub, state-\/>sub);}
\DoxyCodeLine{70             \}}
\DoxyCodeLine{71             current\_sub.unsubscribe();}
\DoxyCodeLine{72             subscriber\_subscription.remove(current\_sub);}
\DoxyCodeLine{73         \});}
\DoxyCodeLine{74 }
\DoxyCodeLine{75         m\_original\_observable.subscribe(m\_state-\/>sub, subscriber.get\_observer());}
\DoxyCodeLine{76 }
\DoxyCodeLine{77         \textcolor{keywordflow}{return} subscription;}
\DoxyCodeLine{78     \}}
\DoxyCodeLine{79 }
\DoxyCodeLine{80 \textcolor{keyword}{private}:}
\DoxyCodeLine{81     OriginalObservable m\_original\_observable;}
\DoxyCodeLine{82     Subject            m\_subject;}
\DoxyCodeLine{83 }
\DoxyCodeLine{84     \textcolor{keyword}{struct }state\_t}
\DoxyCodeLine{85     \{}
\DoxyCodeLine{86         std::mutex             mutex\{\};}
\DoxyCodeLine{87         composite\_subscription sub = composite\_subscription::empty();}
\DoxyCodeLine{88     \};}
\DoxyCodeLine{89 }
\DoxyCodeLine{90     std::shared\_ptr<state\_t> m\_state = std::make\_shared<state\_t>();}
\DoxyCodeLine{91 \};}
\DoxyCodeLine{92 }
\DoxyCodeLine{93 \textcolor{keyword}{template}<constra\textcolor{keywordtype}{int}::observable OriginalObservable, subjects::constra\textcolor{keywordtype}{int}::subject Subject>}
\DoxyCodeLine{94 connectable\_observable(\textcolor{keyword}{const} OriginalObservable\&, \textcolor{keyword}{const} Subject\&) -\/> connectable\_observable<subjects::utils::extract\_subject\_type\_t<Subject>, Subject, OriginalObservable>;}
\DoxyCodeLine{95 \} \textcolor{comment}{// namespace rpp}}

\end{DoxyCode}
